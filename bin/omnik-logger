#!/usr/bin/env python

import os
import argparse
import configparser

from omnik import DataLoggerWifi, DataLoggerEth

def main(c, debug):
  if c.get('default', 'network') == 'wifi':
    url = "http://{0}:{1}/js/status.js".format(c.get('default', 'host'), c.get('default', 'port', fallback=80))
    clazz = DataLoggerWifi(url=url, username=c.get('default','user', fallback='admin'), password=c.get('default', 'password', fallback='admin'), debug=debug)
    clazz.process(c)
  else:
    url = "http://{0}:{1}/status.json?CMD=inv_query".format(c.get('default', 'host'), c.get('default', 'port', fallback=80))
    clazz = DataLoggerEth(url=url, debug=debug)
    clazz.process(c)

if __name__ == '__main__':
  base_dir = os.path.dirname(os.path.realpath(__file__))

  parser = argparse.ArgumentParser()
  parser.add_argument('--config', default='{}/../config.ini'.format(base_dir), help='Path to configuration file', metavar="FILE")
  parser.add_argument('-d', '--debug', action='store_true', help='Debug mode')

  args = parser.parse_args()

  if args.config:
    c = configparser.ConfigParser()
    c.read([args.config], encoding='utf-8')

  main(c, args.debug)